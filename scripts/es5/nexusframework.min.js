var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperties(window,{NexusFrameworkTransport:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkTransport",{value:e})},get:function(){var e;if("XMLHttpRequest"in window){var t=function(){function e(e,t){this._url=t,this.request=e,e.responseType="arraybuffer"}return Object.defineProperty(e.prototype,"url",{get:function(){return this.request.responseURL||this._url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code",{get:function(){return this.request.status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentFromJSON",{get:function(){return this.parsedJson||(this.parsedJson=JSON.parse(this.request.responseText)),this.parsedJson},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsArrayBuffer",{get:function(){return this.request.response},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsString",{get:function(){return this.request.responseText},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"headers",{get:function(){if(!this.processedHeaders){var e=this.processedHeaders={};this.request.getAllResponseHeaders().split(/\r?\n/g).forEach(function(t){var r,n,o=t.indexOf(":");o>0?(r=t.substring(0,o).trim().toLowerCase(),n=t.substring(o+1).trim()):r=t.trim().toLowerCase();var s=e[r];s||(s=e[r]=[]),n&&s.push(n)})}return this.processedHeaders},enumerable:!0,configurable:!0}),e}(),r=function(e,r,n,o,s,a){var i=new XMLHttpRequest;i.open(e,r,!0),Object.keys(s).forEach(function(e){i.setRequestHeader(e,s[e])}),a&&(i.onprogress=function(e){e.lengthComputable&&e.total&&a(e.loaded,e.total)}),i.onreadystatechange=function(e){i.readyState===XMLHttpRequest.DONE&&o(new t(i,r))},i.send(n)};e={get:function(e,t,n,o){r("GET",e,void 0,t,n,o)},head:function(e,t,n,o){r("HEAD",e,void 0,t,n,o)},post:function(e,t,n,o,s){r("POST",e,t,n,o,s)},put:function(e,t,n,o,s){r("PUT",e,t,n,o,s)},execute:r,del:function(e,t,n,o){r("DELETE",e,void 0,t,n,o)}}}else e={get:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},head:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},put:function(e,t,r,n){r({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},post:function(e,t,r,n){r({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},execute:function(e,t,r,n,o){n({url:t,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},del:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})}};return Object.defineProperty(window,"NexusFrameworkTransport",{value:e}),e}},NexusFrameworkImpl:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkImpl",{value:e})},get:function(){var e,t=function(){},r={reportError:t,reportEvent:t,reportPage:t},n=document.createElement("a"),o=location.href.match(/^\w+:/)[0],s=function(e){n.setAttribute("href",e);var t=n.href;return/^\/\//.test(t)&&(t=o+t),t},a=function(e,t){e.addEventListener("transitionend",t),e.addEventListener("transitionEnd",t),e.addEventListener("webkitTransitionEnd",t),e.addEventListener("mozTransitionEnd",t),e.addEventListener("oTransitionEnd",t)},i=function(e,t){e.removeEventListener("transitionend",t),e.removeEventListener("transitionEnd",t),e.removeEventListener("webkitTransitionEnd",t),e.removeEventListener("mozTransitionEnd",t),e.removeEventListener("oTransitionEnd",t)},c=function(e,t){void 0===t&&(t=location.href);var r,n;return"string"==typeof e.data||e.data instanceof String?{url:t,code:e.code,contentAsString:e.data,get contentAsArrayBuffer(){if(!n){n=new ArrayBuffer(e.data.length);for(var t=new Uint8Array(n),r=0,o=e.data.length;r<o;r++)t[r]=e.data.charCodeAt(r)}return n},get contentFromJSON(){return r||(r=JSON.parse(e.data)),r},headers:e.headers}:{url:t,code:e.code,get contentAsString(){return r||(r=JSON.stringify(e.data)),r},get contentAsArrayBuffer(){if(!n){r||(r=JSON.stringify(e.data)),n=new ArrayBuffer(r);for(var t=new Uint8Array(n),o=0,s=r.length;o<s;o++)t[o]=r.charCodeAt(o)}return n},contentFromJSON:e.data,headers:e.headers}},u=/(^|\s)loader\-(progress|error)\-container(\s|$)/,d=function(){function e(e,t){void 0===e&&(e="/"),this.activerid=0,this.components={},this.currentUserID=void 0,this.progressBar=document.getElementsByClassName("loader-progress-bar"),this.progressBarContainer=document.getElementsByClassName("loader-progress-container"),this.progressVisible=!1,this.requestPage=this.defaultRequestPage,e=s(e),/\/$/.test(e)||(e+="/"),Object.defineProperties(this,{io:{value:t},url:{value:e}}),window.ga?this._analytics={reportError:function(e,t){try{window.ga("send","exception",{exDescription:e+"\n\t"+(e.stack||"Stack trace not available").replace(/\n/g,"\n\t"),exFatal:!0})}catch(e){console.warn(e)}},reportEvent:function(e,t,r,n){try{window.ga("send","event",e,t,r,n)}catch(e){console.warn(e)}},reportPage:function(e,t){try{window.ga("send","pageview",e,{page:e,title:t})}catch(e){console.warn(e)}}}:this._analytics=r}return e.prototype.resolveUrl=function(e){return/^\w+\:/.test(e)?e:s(this.url+e)},e.prototype.disableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("a, input, select, textarea, iframe, button, *[focusable], *[tabindex]"),r=0;r<t.length;r++){var n=t[r],o=n.getAttribute("tabindex");if("-1"==o)return;n.setAttribute("data-tabindex",o||""),n.setAttribute("data-tabindex","-1")}},e.prototype.enableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("*[data-tabindex]"),r=0;r<t.length;r++){var n=t[r];n.setAttribute("tabindex",n.getAttribute("data-tabindex")),n.removeAttribute("data-tabindex")}},e.prototype.fadeInProgress=function(e){var t=this;if(this.progressVisible)e&&e();else if(this.progressFadeCallbacks)e&&this.progressFadeCallbacks.push(e);else{for(s=0;s<this.progressBar.length;s++)this.progressBar[s].style.width="0%";if(this.progressBarContainer.length){var r;this.progressFadeCallbacks=[],e&&this.progressFadeCallbacks.push(e);var n=this.progressBarContainer[0],o=function(){try{clearTimeout(r)}catch(e){}i(n,o),t.progressVisible=!0;var e=t.progressFadeCallbacks;delete t.progressFadeCallbacks,e.forEach(function(e){e()})};a(n,o),r=setTimeout(o,500);for(var s=0;s<this.progressBarContainer.length;s++){var c=this.progressBarContainer[s];/(^|\s)loader\-progress\-visible(\s|$)/.test(c.className)||(c.className=(c.className+" loader-progress-visible").trim())}}else this.progressVisible=!0,e&&e()}},e.prototype.fadeOutProgress=function(e){var t=this;if(this.progressVisible)if(this.progressFadeCallbacks)e&&this.progressFadeCallbacks.push(e);else{for(s=0;s<this.progressBar.length;s++)this.progressBar[s].style.width="100%";if(this.progressBarContainer.length){var r;this.progressFadeCallbacks=[],e&&this.progressFadeCallbacks.push(e);var n=this.progressBarContainer[0],o=function(){try{clearTimeout(r)}catch(e){}i(n,o),t.progressVisible=!1;var e=t.progressFadeCallbacks;delete t.progressFadeCallbacks,e.forEach(function(e){e()})};a(n,o),r=setTimeout(o,500);for(var s=0;s<this.progressBarContainer.length;s++){var c=this.progressBarContainer[s];c.className=c.className.replace(/(^|\s)loader\-progress\-visible(\s|$)/g,function(e){return/^\s.+\s$/.test(e)?" ":""})}}else this.progressVisible=!1,e&&e()}else e&&e()},Object.defineProperty(e.prototype,"analytics",{get:function(){return this._analytics},set:function(e){this._analytics=e||r},enumerable:!0,configurable:!0}),e.prototype.reportError=function(e,t){this.errorreporter&&this.errorreporter(e,t)},e.prototype.installErrorReporter=function(e){this.errorreporter=e},e.prototype.registerComponent=function(e,t){var r=this;if(t)this.components[e]=t,this.createComponents(document.head),this.createComponents(document.body);else{delete this.components[e];var n=function(t){var n=t.querySelectorAll(e);if(n.length)for(var o=0;o<n.length;o++){var s=n[o],a=s.__nf_cmapping__;a||(a=s.__nf_cmapping__={});var i=a[e];if(i)try{i.destroy()}catch(e){r.reportError(e)}}};n(document.head),n(document.body)}},e.prototype.unregisterComponent=function(e,t){},e.prototype.createComponents=function(e){var t=this;Object.keys(this.components).forEach(function(r){var n=e.querySelectorAll(r);if(n.length)for(var o=0;o<n.length;o++){var s=n[o],a=s.__nf_cmapping__;if(a||(a=s.__nf_cmapping__={}),!a[r]){var i=t.components[r];try{(a[r]=new i).create(s)}catch(e){t.reportError(e)}}}})},e.prototype.destroyComponents=function(e){var t=this;Object.keys(this.components).forEach(function(r){var n=e.querySelectorAll(r);if(n.length)for(var o=0;o<n.length;o++){var s=n[o],a=s.__nf_cmapping__;a||(a=s.__nf_cmapping__={});var i=a[r];if(i)try{i.destroy()}catch(e){t.reportError(e)}}})},e.prototype.restoreComponents=function(e,t){var r=this;Object.keys(this.components).forEach(function(n){var o=t[n];if(o){var s=e.querySelectorAll(n);if(s.length)for(var a=0;a<s.length;a++){var i=s[a];if(!o.length)break;var c=o.shift();if(c){var u=i.__nf_cmapping__;u||(u=i.__nf_cmapping__={});var d=u[n];if(!d){var l=r.components[n];try{(d=u[n]=new l).create(i)}catch(e){r.reportError(e),console.warn(e);continue}}try{d.restore(c)}catch(e){r.reportError(e),console.warn(e)}}}}})},e.prototype.saveComponents=function(e){var t=this,r={};return Object.keys(this.components).forEach(function(n){var o=r[n]=[],s=e.querySelectorAll(n);if(s.length)for(var a=0;a<s.length;a++){var i=s[a],c=i.__nf_cmapping__;c||(c=i.__nf_cmapping__={});var u=c[n];if(!u){var d=t.components[n];try{(u=c[n]=new d).create(i)}catch(e){o.push(void 0),t.reportError(e),console.warn(e);continue}}try{o.push(u.save())}catch(e){o.push(void 0),t.reportError(e),console.warn(e)}}}),r},e.prototype.initPageSystem=function(e){var t=this;if(!window.NexusFrameworkLoader)return console.warn("The NexusFramework Loader is required for the dynamic Page System to work correctly.");if(!history.pushState||!history.replaceState)return console.warn("This browser is missing an essential feature required for the dynamic Page System.");var r=this,n=function(e){return function(r){var n=r.headers["x-user"];t.currentUserID=n?n[0]:void 0,e(r)}},o={requestPage:function(t,o,s){if(!r.pagesysprerequest||r.pagesysprerequest(t)){e.noprogress||(r.disableAll(),r.fadeInProgress());var a=r.resolveUrl(t),i={accepts:"text/json"},c=e.noprogress?o:function(e){r.fadeInProgress(function(){o(e),r.enableAll()})};s?window.NexusFrameworkTransport.post(a,s,n(c),i):window.NexusFrameworkTransport.get(a,n(c),i)}else r.defaultRequestPage(t,s)}};if(!(e=e||{}).noio&&this.io){var a=this.io;this.pagesysimpl={requestPage:function(t,s,i){if(a.connected){if(r.pagesysprerequest&&!r.pagesysprerequest(t))return void r.defaultRequestPage(t,i);e.noprogress||(r.disableAll(),r.fadeInProgress());var u={referrer:location.href},d=document.cookie;d&&(u.cookie=d),a.emit("page",i?"POST":"GET",t,i,u,function(o){var a=o.headers["set-cookie"];a&&a.forEach(function(e){document.cookie=e});var i=e.noprogress?s:function(e){r.fadeInProgress(function(){s(e),r.enableAll()})};n(i)(c(o,r.resolveUrl(t)))})}else o.requestPage(t,s,i)}}}else this.pagesysimpl=o;var i=document.getElementsByTagName("base");i=i&&i[0],this.pagesysprerequest=e.prerequest,this.pagesyshandler=e.handler||function(e){try{var r=e.headers["content-type"][0];if(!/\/html(;.+)?$/.test(r.toLowerCase()))throw new Error("Content type is not html")}catch(e){}var n=e.contentAsString,o=n.indexOf("<body");if(-1==o)throw new Error("Could not find start of body tag");var s=n.indexOf("</body>")||n.indexOf("</ body>");if(-1==s)throw new Error("Could not find end of body tag");var a=n.match(/<title>([^<]+)<\/\s*title>/);document.title=a&&a[1]||"Title Not Set";var i=document.createElement("html");i.innerHTML=n.substring(o,s)+"</body>";for(var c,d=i.children,l=[],p=0;p<d.length;p++){switch((h=d[p]).nodeName.toUpperCase()){case"HEAD":break;case"BODY":p=-1,d=h.children;break;case"SCRIPT":var f=h.innerHTML.match(/^NexusFrameworkLoader\.load\((.+)\);?$/);f&&(c=JSON.parse(f[1]));break;default:if(u.test(h.className))break;l.push(h)}}if(!l.length)throw new Error("Nothing found in response to add to page");if(!c)throw new Error("NexusFrameworkLoader script not found...");for(p=(d=document.body.children).length-1;p>=0;p--){var h=d[p];switch(h.nodeName.toUpperCase()){case"SCRIPT":break;default:if(u.test(h.className))break;document.body.removeChild(h)}}return l.forEach(function(e){document.body.appendChild(e)}),window.NexusFrameworkLoader.load(c,t.fadeOutProgress.bind(t)),!0};var d,l=new RegExp("^"+this.url.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"(.*)$","i"),p=function(){function e(){var e=this;this.handler=function(t){if(!e.element.hasAttribute("data-nopagesys")&&!e.element.hasAttribute("data-nodynamic")){var n=e.element.href;if(l.test(n))try{var o=n.match(/^(.+)#.*$/);o&&(n=o[1]),r.requestPage(n.substring(r.url.length));try{t.stopPropagation()}catch(t){}try{t.preventDefault()}catch(t){}}catch(t){console.warn(t)}else console.log("Navigating",n)}}}return e.prototype.create=function(e){e.addEventListener("click",this.handler),this.element=e},e.prototype.destroy=function(){this.element.removeEventListener("click",this.handler)},e.prototype.restore=function(e){},e.prototype.save=function(){},e}(),f=function(e){var r={user:t.currentUserID};return e&&(r.title=document.title,r.body=t.saveComponents(document.body),r.basehref=i?i.href:void 0,r.page=e),r};return this.requestPage=function(e,r,n){if(void 0===n&&(n=!1),/\..+$/.test(e))t.defaultRequestPage(e,r);else{var o=++t.activerid;document.title="Loading...";var a=t.resolveUrl(e);console.log(a,n,o),history[n?"replaceState":"pushState"](f(),"Loading...",a),t.pagesysimpl.requestPage(e,function(n){try{if(o!=t.activerid)return;var i=n.headers.location;if(i){var c=s(i[0]);return l.test(c)?void t.requestPage(c.substring(t.url.length),void 0,!0):(console.warn("Requested redirect to url outside of website:",c),void(window.location.href=c))}var u=n.headers["content-disposition"];if(u&&"attachment"==u[0].toLowerCase())throw new Error("Attachment disposition");if(!t.pagesyshandler(n))throw new Error("Could not handle response");var p=n.headers["content-type"];history.replaceState(f({code:n.code,headers:n.headers,data:p&&/\/json(;.+)?$/.test(p[0])?n.contentFromJSON:n.contentAsString}),document.title,a)}catch(t){console.warn(t),d=[e,r];try{history.go(-1)}catch(e){}}},r)}},this.registerComponent("a",p),window.addEventListener("popstate",function(e){if(d){var n=d;return setTimeout(function(){t.defaultRequestPage(n[0],n[1])}),void(d=void 0)}try{if(e.state.user!=t.currentUserID)throw new Error("User has changed since state was created, reloading...");var o=e.state.page;if(!o)throw new Error("Page was never loaded or page data is corrupt, reloading...");document.title=e.state.title,t.pagesyshandler(c(o)),t.restoreComponents(document.body,e.state.body)}catch(n){console.warn(n);var s=location.href;if(l.test(s))try{if(/reloading\.\.\.$/.test(n.message))return void t.requestPage(s.substring(r.url.length),void 0,!0);console.error("Unknown error occured, actually navigating to page...")}catch(e){console.error(e)}location.reload(!0)}}),history.replaceState(f(),document.title,location.href),!0},e.prototype.defaultRequestPage=function(e,t){if(t)throw new Error("Posting is not supported without an initialized page system, yet");location.href=this.resolveUrl(e)},e}();return e=window.io?function(e){function t(t){var r=e.call(this,t,window.io({path:"/:io"}))||this,n=r.io;return n.on("connect",function(){n.emit("init",window.NexusFrameworkLoader.requestedResources())}),r}return __extends(t,e),t}(d):function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t}(d),Object.defineProperty(window,"NexusFrameworkImpl",{value:e}),e}},NexusFramework:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFramework",{value:e})},get:function(){var e=new window.NexusFrameworkImpl;return Object.defineProperty(window,"NexusFramework",{value:e}),e}}});
//# sourceMappingURL=nexusframework.min.js.map