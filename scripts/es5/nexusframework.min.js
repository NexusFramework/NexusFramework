var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}();Object.defineProperties(window,{NexusFrameworkTransport:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkTransport",{value:e})},get:function(){var e;if("XMLHttpRequest"in window){var t=function(){function e(e,t){this._url=t,this.request=e,e.responseType="arraybuffer"}return Object.defineProperty(e.prototype,"url",{get:function(){return this.request.responseURL||this._url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code",{get:function(){return this.request.status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentFromJSON",{get:function(){return this.parsedJson||(this.parsedJson=JSON.parse(this.request.responseText)),this.parsedJson},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsArrayBuffer",{get:function(){return this.request.response},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsString",{get:function(){return this.request.responseText},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"headers",{get:function(){if(!this.processedHeaders){var e=this.processedHeaders={};this.request.getAllResponseHeaders().split(/\r?\n/g).forEach(function(t){var r,o,n=t.indexOf(":");n>0?(r=t.substring(0,n).trim().toLowerCase(),o=t.substring(n+1).trim()):r=t.trim().toLowerCase();var s=e[r];s||(s=e[r]=[]),o&&s.push(o)})}return this.processedHeaders},enumerable:!0,configurable:!0}),e}(),r=function(e,r,o,n,s,a){var i=new XMLHttpRequest;i.open(e,r,!0),Object.keys(s).forEach(function(e){i.setRequestHeader(e,s[e])}),a&&(i.onprogress=function(e){e.lengthComputable&&e.total&&a(e.loaded,e.total)}),i.onreadystatechange=function(e){i.readyState===XMLHttpRequest.DONE&&n(new t(i,r))},i.send(o)};e={get:function(e,t,o,n){r("GET",e,void 0,t,o,n)},head:function(e,t,o,n){r("HEAD",e,void 0,t,o,n)},post:function(e,t,o,n,s){r("POST",e,t,o,n,s)},put:function(e,t,o,n,s){r("PUT",e,t,o,n,s)},execute:r,del:function(e,t,o,n){r("DELETE",e,void 0,t,o,n)}}}else e={get:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},head:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},put:function(e,t,r,o){r({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},post:function(e,t,r,o){r({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},execute:function(e,t,r,o,n){o({url:t,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})},del:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsArrayBuffer:new ArrayBuffer(0),contentAsString:"",headers:{}})}};return Object.defineProperty(window,"NexusFrameworkTransport",{value:e}),e}},NexusFrameworkImpl:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkImpl",{value:e})},get:function(){var e,t=function(){},r={reportError:t,reportEvent:t,reportPage:t},o=document.createElement("a"),n=location.href.match(/^\w+:/)[0],s=function(e){o.setAttribute("href",e);var t=o.href;return/^\/\//.test(t)&&(t=n+t),t},a=function(e,t){e.addEventListener("transitionend",t),e.addEventListener("transitionEnd",t),e.addEventListener("webkitTransitionEnd",t),e.addEventListener("mozTransitionEnd",t),e.addEventListener("oTransitionEnd",t)},i=function(e,t){e.removeEventListener("transitionend",t),e.removeEventListener("transitionEnd",t),e.removeEventListener("webkitTransitionEnd",t),e.removeEventListener("mozTransitionEnd",t),e.removeEventListener("oTransitionEnd",t)},c=function(e,t){void 0===t&&(t=location.href);var r,o;return"string"==typeof e.data||e.data instanceof String?{url:t,code:e.code,contentAsString:e.data,get contentAsArrayBuffer(){if(!o){o=new ArrayBuffer(e.data.length);for(var t=new Uint8Array(o),r=0,n=e.data.length;r<n;r++)t[r]=e.data.charCodeAt(r)}return o},get contentFromJSON(){return r||(r=JSON.parse(e.data)),r},headers:e.headers}:{url:t,code:e.code,get contentAsString(){return r||(r=JSON.stringify(e.data)),r},get contentAsArrayBuffer(){if(!o){r||(r=JSON.stringify(e.data)),o=new ArrayBuffer(r);for(var t=new Uint8Array(o),n=0,s=r.length;n<s;n++)t[n]=r.charCodeAt(n)}return o},contentFromJSON:e.data,headers:e.headers}},u=/(^|\s)loader\-(progress|error)\-container(\s|$)/,l=function(){function e(e,t){void 0===e&&(e="/"),this.activerid=0,this.components={},this.currentUserID=void 0,this.progressBar=document.getElementsByClassName("loader-progress-bar"),this.progressBarContainer=document.getElementsByClassName("loader-progress-container"),this.progressVisible=!1,this.requestPage=this.defaultRequestPage,e=s(e),/\/$/.test(e)||(e+="/"),Object.defineProperties(this,{io:{value:t},url:{value:e}}),window.ga?this._analytics={reportError:function(e,t){try{window.ga("send","exception",{exDescription:e+"\n\t"+(e.stack||"Stack trace not available").replace(/\n/g,"\n\t"),exFatal:!0})}catch(e){console.warn(e)}},reportEvent:function(e,t,r,o){try{window.ga("send","event",e,t,r,o)}catch(e){console.warn(e)}},reportPage:function(e,t){try{window.ga("send","pageview",e,{page:e,title:t})}catch(e){console.warn(e)}}}:this._analytics=r}return e.prototype.resolveUrl=function(e){return/^\w+\:/.test(e)?e:s(this.url+e)},e.prototype.disableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("a, input, select, textarea, iframe, button, *[focusable], *[tabindex]"),r=0;r<t.length;r++){var o=t[r],n=o.getAttribute("tabindex");if("-1"==n)return;o.setAttribute("data-tabindex",n||""),o.setAttribute("data-tabindex","-1")}},e.prototype.enableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("*[data-tabindex]"),r=0;r<t.length;r++){var o=t[r];o.setAttribute("tabindex",o.getAttribute("data-tabindex")),o.removeAttribute("data-tabindex")}},e.prototype.fadeInProgress=function(e){var t=this;if(this.progressVisible)e&&e();else if(this.progressFadeCallbacks)e&&this.progressFadeCallbacks.push(e);else{for(s=0;s<this.progressBar.length;s++)this.progressBar[s].style.width="0%";if(this.progressBarContainer.length){var r;this.progressFadeCallbacks=[],e&&this.progressFadeCallbacks.push(e);var o=this.progressBarContainer[0],n=function(){try{clearTimeout(r)}catch(e){}i(o,n),t.progressVisible=!0;var e=t.progressFadeCallbacks;delete t.progressFadeCallbacks,e.forEach(function(e){e()})};a(o,n),r=setTimeout(n,500);for(var s=0;s<this.progressBarContainer.length;s++){var c=this.progressBarContainer[s];/(^|\s)loader\-progress\-visible(\s|$)/.test(c.className)||(c.className=(c.className+" loader-progress-visible").trim())}}else this.progressVisible=!0,e&&e()}},e.prototype.fadeOutProgress=function(e){var t=this;if(this.progressVisible)if(this.progressFadeCallbacks)e&&this.progressFadeCallbacks.push(e);else{for(s=0;s<this.progressBar.length;s++)this.progressBar[s].style.width="100%";if(this.progressBarContainer.length){var r;this.progressFadeCallbacks=[],e&&this.progressFadeCallbacks.push(e);var o=this.progressBarContainer[0],n=function(){try{clearTimeout(r)}catch(e){}i(o,n),t.progressVisible=!1;var e=t.progressFadeCallbacks;delete t.progressFadeCallbacks,e.forEach(function(e){e()})};a(o,n),r=setTimeout(n,500);for(var s=0;s<this.progressBarContainer.length;s++){var c=this.progressBarContainer[s];c.className=c.className.replace(/(^|\s)loader\-progress\-visible(\s|$)/g,function(e){return/^\s.+\s$/.test(e)?" ":""})}}else this.progressVisible=!1,e&&e()}else e&&e()},Object.defineProperty(e.prototype,"analytics",{get:function(){return this._analytics},set:function(e){this._analytics=e||r},enumerable:!0,configurable:!0}),e.prototype.reportError=function(e,t){this.errorreporter&&this.errorreporter(e,t)},e.prototype.installErrorReporter=function(e){this.errorreporter=e},e.prototype.registerComponent=function(e,t){var r=this;if(t)this.components[e]=t,this.createComponents(document.head),this.createComponents(document.body);else{delete this.components[e];var o=function(t){var o=t.querySelectorAll(e);if(o.length)for(var n=0;n<o.length;n++){var s=o[n],a=s.__nf_cmapping__;a||(a=s.__nf_cmapping__={});var i=a[e];if(i)try{i.destroy()}catch(e){r.reportError(e)}}};o(document.head),o(document.body)}},e.prototype.unregisterComponent=function(e,t){},e.prototype.createComponents=function(e){var t=this;Object.keys(this.components).forEach(function(r){var o=e.querySelectorAll(r);if(o.length)for(var n=0;n<o.length;n++){var s=o[n],a=s.__nf_cmapping__;if(a||(a=s.__nf_cmapping__={}),!a[r]){var i=t.components[r];try{(a[r]=new i).create(s)}catch(e){t.reportError(e)}}}})},e.prototype.destroyComponents=function(e){var t=this;Object.keys(this.components).forEach(function(r){var o=e.querySelectorAll(r);if(o.length)for(var n=0;n<o.length;n++){var s=o[n],a=s.__nf_cmapping__;a||(a=s.__nf_cmapping__={});var i=a[r];if(i)try{i.destroy()}catch(e){t.reportError(e)}}})},e.prototype.restoreComponents=function(e,t){var r=this;Object.keys(this.components).forEach(function(o){var n=t[o];if(n){var s=e.querySelectorAll(o);if(s.length)for(var a=0;a<s.length;a++){var i=s[a];if(!n.length)break;var c=n.shift();if(c){var u=i.__nf_cmapping__;u||(u=i.__nf_cmapping__={});var l=u[o];if(!l){var d=r.components[o];try{(l=u[o]=new d).create(i)}catch(e){r.reportError(e),console.warn(e);continue}}try{l.restore(c)}catch(e){r.reportError(e),console.warn(e)}}}}})},e.prototype.saveComponents=function(e){var t=this,r={};return Object.keys(this.components).forEach(function(o){var n=r[o]=[],s=e.querySelectorAll(o);if(s.length)for(var a=0;a<s.length;a++){var i=s[a],c=i.__nf_cmapping__;c||(c=i.__nf_cmapping__={});var u=c[o];if(!u){var l=t.components[o];try{(u=c[o]=new l).create(i)}catch(e){n.push(void 0),t.reportError(e),console.warn(e);continue}}try{n.push(u.save())}catch(e){n.push(void 0),t.reportError(e),console.warn(e)}}}),r},e.prototype.initPageSystem=function(e){var t=this;if(!window.NexusFrameworkLoader)return console.warn("The NexusFramework Loader is required for the dynamic Page System to work correctly.");if(!history.pushState||!history.replaceState)return console.warn("This browser is missing an essential feature required for the dynamic Page System.");var r,o=this,n=function(e){return function(r){var o=r.headers["x-user"];t.currentUserID=o?o[0]:void 0,e(r)}},a={requestPage:function(t,r,s,a){if(!o.pagesysprerequest||o.pagesysprerequest(t)){e.noprogress||(o.disableAll(),o.fadeInProgress());var i=o.resolveUrl(t),c={accepts:"text/json"},u=e.noprogress?r:function(e){o.fadeInProgress(function(){r(e),o.enableAll()})};s?window.NexusFrameworkTransport.post(i,s,n(u),c):window.NexusFrameworkTransport.get(i,n(u),c)}else o.defaultRequestPage(t,s)}};if(!(e=e||{}).noio&&this.io){var i=this.io;this.pagesysimpl={requestPage:function(t,r,s,u){if(i.connected){if(o.pagesysprerequest&&!o.pagesysprerequest(t))return void o.defaultRequestPage(t,s);e.noprogress||(o.disableAll(),o.fadeInProgress());var l={referrer:location.href},d=document.cookie;d&&(l.cookie=d),i.emit("page",s?"POST":"GET",t,s,l,function(s){if(u==o.activerid){var a=s.headers["set-cookie"];a&&a.forEach(function(e){document.cookie=e});var i=e.noprogress?r:function(e){o.fadeInProgress(function(){r(e),o.enableAll()})};n(i)(c(s,o.resolveUrl(t)))}})}else a.requestPage(t,r,s,u)}}}else this.pagesysimpl=a;var l=document.getElementsByTagName("base");l=l&&l[0],this.pagesysprerequest=e.prerequest,this.pagesyshandler=e.handler||function(e){try{var r=e.headers["content-type"][0];if(!/\/html(;.+)?$/.test(r.toLowerCase()))throw new Error("Content type is not html")}catch(e){}var o=e.contentAsString,n=o.indexOf("<body");if(-1==n)throw new Error("Could not find start of body tag");var s=o.indexOf("</body>")||o.indexOf("</ body>");if(-1==s)throw new Error("Could not find end of body tag");var a=o.match(/<title>([^<]+)<\/\s*title>/);document.title=a&&a[1]||"Title Not Set";var i=document.createElement("html");i.innerHTML=o.substring(n,s)+"</body>";for(var c,l=i.children,d=[],p=0;p<l.length;p++){switch((h=l[p]).nodeName.toUpperCase()){case"HEAD":break;case"BODY":p=-1,l=h.children;break;case"SCRIPT":var f=h.innerHTML.match(/^NexusFrameworkLoader\.load\((.+)\);?$/);f&&(c=JSON.parse(f[1]));break;default:if(u.test(h.className))break;d.push(h)}}if(!d.length)throw new Error("Nothing found in response to add to page");if(!c)throw new Error("NexusFrameworkLoader script not found...");for(p=(l=document.body.children).length-1;p>=0;p--){var h=l[p];switch(h.nodeName.toUpperCase()){case"LINK":case"SCRIPT":break;default:if(u.test(h.className))break;document.body.removeChild(h)}}return d.forEach(function(e){document.body.appendChild(e)}),window.NexusFrameworkLoader.load(c,t.fadeOutProgress.bind(t)),!0};var d,p=new RegExp("^"+this.url.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"(.*)$","i"),f=function(){function e(){var e=this;this.handler=function(t){if(!e.element.hasAttribute("data-nopagesys")&&!e.element.hasAttribute("data-nodynamic")){var r=e.element.href;if(p.test(r))try{var n=r.match(/^(.+)#.*$/);n&&(r=n[1]),o.requestPage(r.substring(o.url.length));try{t.stopPropagation()}catch(t){}try{t.preventDefault()}catch(t){}}catch(t){console.warn(t)}else console.log("Navigating",r)}}}return e.prototype.create=function(e){e.addEventListener("click",this.handler),this.element=e},e.prototype.destroy=function(){this.element.removeEventListener("click",this.handler)},e.prototype.restore=function(e){},e.prototype.save=function(){},e}(),h=function(e){if(e)return{title:document.title,user:t.currentUserID,scroll:[window.scrollX,window.scrollY],body:t.saveComponents(document.body),basehref:l?l.href:void 0,page:e}};return this.requestPage=function(e,o,n){if(void 0===n&&(n=!1),/\..+$/.test(e))t.defaultRequestPage(e,o);else{var a=++t.activerid,i=t.resolveUrl(e);console.log(i,n,a),n?history.replaceState(h(r),"Loading...",i):(history.replaceState(h(r),document.title,location.href),history.pushState(h(),"Loading...",i),r=void 0,window.scrollTo(0,0)),t.pagesysimpl.requestPage(e,function(n){try{if(a!=t.activerid)return;var c=n.headers.location;if(c){var u=s(c[0]);return p.test(u)?void t.requestPage(u.substring(t.url.length),void 0,!0):(console.warn("Requested redirect to url outside of website:",u),void(window.location.href=u))}var l=n.headers["content-disposition"];if(l&&"attachment"==l[0].toLowerCase())throw new Error("Attachment disposition");if(!t.pagesyshandler(n))throw new Error("Could not handle response");var f=n.headers["content-type"];history.replaceState(h(r={code:n.code,headers:n.headers,data:f&&/\/json(;.+)?$/.test(f[0])?n.contentFromJSON:n.contentAsString}),document.title,i)}catch(t){console.warn(t),d=[e,o];try{history.go(-1)}catch(e){}}},o,a)}},this.registerComponent("a",f),window.addEventListener("popstate",function(e){if(d){var r=d;return setTimeout(function(){t.defaultRequestPage(r[0],r[1])}),void(d=void 0)}try{if(!e.state)throw new Error("No state, reloading...");if(e.state.user!=t.currentUserID)throw new Error("User has changed since state was created, reloading...");var n=e.state.page;if(!n)throw new Error("Page was never loaded or page data is corrupt, reloading...");document.title=e.state.title,t.pagesyshandler(c(n)),t.restoreComponents(document.body,e.state.body),window.scrollTo.apply(window,e.state.scroll)}catch(r){console.warn(r);var s=location.href;if(p.test(s))try{if(/reloading\.\.\.$/.test(r.message))return void t.requestPage(s.substring(o.url.length),void 0,!0);console.error("Unknown error occured, actually navigating to page...")}catch(e){console.error(e)}location.reload(!0)}}),!0},e.prototype.defaultRequestPage=function(e,t){if(t)throw new Error("Posting is not supported without an initialized page system, yet");location.href=this.resolveUrl(e)},e}();return e=window.io?function(e){function t(t){var r=e.call(this,t,window.io({path:"/:io"}))||this,o=r.io;return o.on("connect",function(){o.emit("init",window.NexusFrameworkLoader.requestedResources())}),r}return __extends(t,e),t}(l):function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t}(l),Object.defineProperty(window,"NexusFrameworkImpl",{value:e}),e}},NexusFramework:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFramework",{value:e})},get:function(){var e=new window.NexusFrameworkImpl;return Object.defineProperty(window,"NexusFramework",{value:e}),e}}});
//# sourceMappingURL=nexusframework.min.js.map