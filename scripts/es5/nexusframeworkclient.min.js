var __extends=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperties(window,{NexusFrameworkTransport:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkTransport",{value:e})},get:function(){var e;if("XMLHttpRequest"in window){var i=function(){function e(e,t){this._url=t,this.request=e}return Object.defineProperty(e.prototype,"url",{get:function(){return this.request.responseURL||this._url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code",{get:function(){return this.request.status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentFromJSON",{get:function(){return this.parsedJson||(this.parsedJson=JSON.parse(this.request.responseText)),this.parsedJson},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsString",{get:function(){return this.request.responseText},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"headers",{get:function(){if(!this.processedHeaders){var s=this.processedHeaders={};this.request.getAllResponseHeaders().split(/\r?\n/g).forEach(function(e){var t,r,o=e.indexOf(":");0<o?(t=e.substring(0,o).trim().toLowerCase(),r=e.substring(o+1).trim()):t=e.trim().toLowerCase();var n=s[t];n||(n=s[t]=[]),r&&n.push(r)})}return this.processedHeaders},enumerable:!0,configurable:!0}),e}(),s=function(e,t,r,o,n,s){var a=new XMLHttpRequest;a.open(e,t,!0),n&&Object.keys(n).forEach(function(e){a.setRequestHeader(e,n[e])}),s&&(a.onprogress=function(e){e.lengthComputable&&e.total&&s(e.loaded,e.total)}),a.onreadystatechange=function(e){a.readyState===XMLHttpRequest.DONE&&o(new i(a,t))},a.send(r)};e={get:function(e,t,r,o){s("GET",e,void 0,t,r,o)},head:function(e,t,r,o){s("HEAD",e,void 0,t,r,o)},post:function(e,t,r,o,n){s("POST",e,t,r,o,n)},put:function(e,t,r,o,n){s("PUT",e,t,r,o,n)},execute:s,del:function(e,t,r,o){s("DELETE",e,void 0,t,r,o)}}}else e={get:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",headers:{}})},head:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",headers:{}})},put:function(e,t,r,o){r({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",headers:{}})},post:function(e,t,r,o){r({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",headers:{}})},execute:function(e,t,r,o,n){o({url:t,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",headers:{}})},del:function(e,t,r){t({url:e,code:503,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",headers:{}})}};return Object.defineProperty(window,"NexusFrameworkTransport",{value:e}),e}},NexusFrameworkImpl:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkImpl",{value:e})},get:function(){var v,y=window.NexusFrameworkLoader,w=y.showError,b=console.log.bind(console);y.showError=function(e){history.replaceState({error:e.stack||""+e},document.title,location.href),v=void 0,w(e)};var e,r={reportError:function(e,t){if(window.ga)try{window.ga("send","exception",{exDescription:(e.stack||""+e).replace(/\n/g,"\n\t"),exFatal:t})}catch(e){console.warn(e)}},reportEvent:function(e,t,r,o){if(window.ga)try{window.ga("send","event",e,t,r,o)}catch(e){console.warn(e)}},reportPage:function(e){if(window.ga)try{e||(e=location.pathname),window.ga("set","page",e),window.ga("send","pageview")}catch(e){console.warn(e)}}},o=document.createElement("a"),n=location.href.match(/^\w+:/)[0],_=function(e){o.setAttribute("href",e);var t=o.href;return/^\/\//.test(t)&&(t=n+t),t},E=function(e,t){var r;return void 0===t&&(t=location.href),"string"==typeof e.data||e.data instanceof String?{url:t,code:e.code,contentAsString:e.data,get contentFromJSON(){return r||(r=JSON.parse(e.data)),r},headers:e.headers}:{url:t,code:e.code,get contentAsString(){return r||(r=JSON.stringify(e.data)),r},contentFromJSON:e.data,headers:e.headers}},N=/(^|\s)loader\-(progress|error)\-container(\s|$)/,t=function(){function e(e,t){void 0===e&&(e="/"),this.activerid=0,this.components={},this.currentUserID=void 0,this.progressBar=document.getElementsByClassName("loader-progress-bar"),this.progressBarContainer=document.getElementsByClassName("loader-progress-container"),this.progressVisible=!1,this.animationTiming=500,this.requestPage=this.defaultRequestPage,this._listeners={},e=_(e),/\/$/.test(e)||(e+="/"),Object.defineProperties(this,{io:{value:t},url:{value:e}}),this._analytics=r}return e.prototype.resolveUrl=function(e){return/^\w+\:/.test(e)?e:_(this.url+e)},e.prototype.disableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("a, input, select, textarea, iframe, button, *[focusable], *[tabindex]"),r=0;r<t.length;r++){var o=t[r],n=o.getAttribute("tabindex");if("-1"==n)return;o.setAttribute("data-tabindex",n||""),o.setAttribute("data-tabindex","-1")}},e.prototype.enableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("*[data-tabindex]"),r=0;r<t.length;r++){var o=t[r];o.setAttribute("tabindex",o.getAttribute("data-tabindex")),o.removeAttribute("data-tabindex")}},e.prototype.fadeInProgress=function(e){var r=this;if(this.progressVisible)e&&e();else if(this.progressFadeCallbacks)e&&this.progressFadeCallbacks.push(e);else{for(var t=function(){try{var e=o.progressBar[n],t=e.className;e.className+=" noani",e.style.width="0%",setTimeout(function(){e.className=t})}catch(e){}},o=this,n=0;n<this.progressBar.length;n++)t();if(this.progressBarContainer.length){var s;this.progressFadeCallbacks=[],e&&this.progressFadeCallbacks.push(e);this.progressBarContainer[0];s=setTimeout(function(){try{clearTimeout(s)}catch(e){}r.progressVisible=!0;var e=r.progressFadeCallbacks;delete r.progressFadeCallbacks,e.forEach(function(e){e()})},this.animationTiming),setTimeout(function(){for(var e=0;e<r.progressBarContainer.length;e++){var t=r.progressBarContainer[e];/(^|\s)loader\-progress\-visible(\s|$)/.test(t.className)||(t.className=(t.className+" loader-progress-visible").trim())}})}else this.progressVisible=!0,e&&e()}},e.prototype.fadeOutProgress=function(e){var t=this;if(this.progressVisible)if(this.progressFadeCallbacks)e&&this.progressFadeCallbacks.push(e);else{for(var r=0;r<this.progressBar.length;r++)this.progressBar[r].style.width="100%";if(this.progressBarContainer.length){var o;this.progressFadeCallbacks=[],e&&this.progressFadeCallbacks.push(e);this.progressBarContainer[0];o=setTimeout(function(){try{clearTimeout(o)}catch(e){}t.progressVisible=!1;var e=t.progressFadeCallbacks;delete t.progressFadeCallbacks,e.forEach(function(e){e()})},this.animationTiming);for(r=0;r<this.progressBarContainer.length;r++){var n=this.progressBarContainer[r];n.className=n.className.replace(/(^|\s)loader\-progress\-visible(\s|$)/g,function(e){return/^\s.+\s$/.test(e)?" ":""})}}else this.progressVisible=!1,e&&e()}else e&&e()},Object.defineProperty(e.prototype,"analytics",{get:function(){return this._analytics},set:function(e){this._analytics=e||r},enumerable:!0,configurable:!0}),e.prototype.reportError=function(e,t){console[t?"error":"warn"](e.stack),this.errorreporter&&this.errorreporter(e,t)},e.prototype.installErrorReporter=function(e){this.errorreporter=e},e.prototype.registerComponent=function(a,e){var i=this;if(e)this.components[a]=e,this.createComponents(document.head),this.createComponents(document.body);else{delete this.components[a];var t=function(e){var t=e.querySelectorAll(a);if(t.length)for(var r=0;r<t.length;r++){var o=t[r],n=o.__nf_cmapping__;n||(n=o.__nf_cmapping__={});var s=n[a];if(s)try{s.destroy()}catch(e){i.reportError(e)}}};t(document.head),t(document.body)}},e.prototype.unregisterComponent=function(e,t){},e.prototype.createComponents=function(a){var i=this;Object.keys(this.components).forEach(function(e){var t=a.querySelectorAll(e);if(t.length)for(var r=0;r<t.length;r++){var o=t[r],n=o.__nf_cmapping__;if(n||(n=o.__nf_cmapping__={}),!n[e]){var s=i.components[e];try{(n[e]=new s).create(o)}catch(e){i.reportError(e)}}}})},e.prototype.destroyComponents=function(a){var i=this;Object.keys(this.components).forEach(function(e){var t=a.querySelectorAll(e);if(t.length)for(var r=0;r<t.length;r++){var o=t[r],n=o.__nf_cmapping__;n||(n=o.__nf_cmapping__={});var s=n[e];if(s)try{s.destroy()}catch(e){i.reportError(e)}}})},e.prototype.restoreComponents=function(l,u){var p=this;Object.keys(this.components).forEach(function(e){var t=u[e];if(t){var r=l.querySelectorAll(e);if(r.length)for(var o=0;o<r.length;o++){var n=r[o];if(!t.length)break;var s=t.shift();if(s){var a=n.__nf_cmapping__;a||(a=n.__nf_cmapping__={});var i=a[e];if(!i){var c=p.components[e];try{(i=a[e]=new c).create(n)}catch(e){p.reportError(e),console.warn(e);continue}}try{i.restore(s)}catch(e){p.reportError(e),console.warn(e)}}}}})},e.prototype.saveComponents=function(c){var l=this,u={};return Object.keys(this.components).forEach(function(e){var t=u[e]=[],r=c.querySelectorAll(e);if(r.length)for(var o=0;o<r.length;o++){var n=r[o],s=n.__nf_cmapping__;s||(s=n.__nf_cmapping__={});var a=s[e];if(!a){var i=l.components[e];try{(a=s[e]=new i).create(n)}catch(e){t.push(void 0),l.reportError(e),console.warn(e);continue}}try{t.push(a.save())}catch(e){t.push(void 0),l.reportError(e),console.warn(e)}}}),u},e.prototype.initPageSystem=function(a){var f=this;if(!y)return console.warn("The NexusFramework Loader is required for the dynamic Page System to work correctly.");if(!history.pushState||!history.replaceState)return console.warn("This browser is missing an essential feature required for the dynamic Page System.");a=a||{};var g=this;this.animationTiming=a.animationTiming||500;var i=function(r){return function(e){var t=e.headers["x-user"];f.currentUserID=t?t[0]:void 0,r(e),200===e.code&&setTimeout(function(){f._analytics.reportPage()})}},c={requestPage:function(e,t,r,o){if(!g.pagesysprerequest||g.pagesysprerequest(e)){a.noprogress||(g.disableAll(),g.fadeInProgress());var n=g.resolveUrl(":pagesys/"+e),s=a.noprogress?t:function(e){g.fadeInProgress(function(){t(e),g.enableAll()})};r?window.NexusFrameworkTransport.post(n,r,i(s)):window.NexusFrameworkTransport.get(n,i(s))}else g.defaultRequestPage(e,r)}};if(a.noio||a.nopagesysio||!this.io)this.pagesysimpl=c;else{var l=this.io;this.pagesysimpl={requestPage:function(o,n,e,s){if(l.connected){if(g.pagesysprerequest&&!g.pagesysprerequest(o))return void g.defaultRequestPage(o,e);a.noprogress||(g.disableAll(),g.fadeInProgress());var t={referrer:location.href},r=document.cookie;r&&(t.cookie=r),l.emit("page",e?"POST":"GET",o,e,t,function(e){if(s==g.activerid){var t=e.headers["set-cookie"];t&&t.forEach(function(e){document.cookie=e});var r=a.noprogress?n:function(e){g.fadeInProgress(function(){n(e),g.enableAll()})};i(r)(E(e,g.resolveUrl(o)))}})}else c.requestPage(o,n,e,s)}}}var u,t=document.getElementsByTagName("base");t=t&&t[0],this.pagesysprerequest=a.prerequest,this.pagesyshandler=a.handler||function(e){try{var t=e.headers["content-type"][0];if(!/\/html(;.+)?$/.test(t.toLowerCase()))throw new Error("Content type is not html")}catch(e){}var r=e.contentAsString,o=r.indexOf("<body");if(-1==o)throw new Error("Could not find start of body tag");var n=r.indexOf("</body>")||r.indexOf("</ body>");if(-1==n)throw new Error("Could not find end of body tag");var s=r.match(/<title>([^<]+)<\/\s*title>/);document.title=s&&s[1]||"Title Not Set";var a,i=document.createElement("html");i.innerHTML=r.substring(o,n)+"</body>";for(var c=i.children,l=[],u=0;u<c.length;u++){switch((d=c[u]).nodeName.toUpperCase()){case"HEAD":break;case"BODY":u=-1,c=d.children;break;case"SCRIPT":var p=d.innerHTML.match(/^NexusFrameworkLoader\.load\((.+)\);?$/);p&&(a=JSON.parse(p[1]));break;default:if(N.test(d.className))break;l.push(d)}}if(!l.length)throw new Error("Nothing found in response to add to page");if(!a)throw new Error("NexusFrameworkLoader script not found...");for(u=(c=document.body.children).length-1;0<=u;u--){var d;switch((d=c[u]).nodeName.toUpperCase()){case"LINK":case"SCRIPT":break;default:if(N.test(d.className))break;document.body.removeChild(d)}}var h=document.createDocumentFragment();return l.forEach(function(e){h.appendChild(e),f.createComponents(e)}),document.body.appendChild(h),y.load(a,function(){g.progressVisible=!0,g.fadeOutProgress()}),!0};var p=/^([^#]+)(#.*)?$/,d=location.href.match(p),h=new RegExp("^"+this.url.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"(.*)$","i"),e=function(){function e(){var s=this;this.handler=function(e){if(!s.element.hasAttribute("data-nopagesys")&&!s.element.hasAttribute("data-nodynamic")){var t=s.element.getAttribute("href");if(t&&t.length){var r=s.element.href,o=r.match(p);if(!(o&&d&&o[2]&&d[1]===o[1]))if(d=o,h.test(r))try{var n=r.match(/^(.+)#.*$/);n&&(r=n[1]),g.requestPage(r.substring(g.url.length));try{e.stopPropagation()}catch(e){}try{e.preventDefault()}catch(e){}}catch(e){console.warn(e)}else b("Navigating",r)}}}}return e.prototype.create=function(e){e.addEventListener("click",this.handler),this.element=e},e.prototype.destroy=function(){this.element.removeEventListener("click",this.handler)},e.prototype.restore=function(e){},e.prototype.save=function(){},e}(),m=function(e){if(e)return{title:document.title,user:f.currentUserID,scroll:[window.scrollX,window.scrollY],body:f.saveComponents(document.body),basehref:t?t.href:void 0,page:e}};return this.requestPage=function(s,a,e){void 0===e&&(e=!1);var t=s.match(/\.([^\/]+)([\?#].*)?$/);if(t&&"htm"!==t[0]&&"html"!==t[0])f.defaultRequestPage(s,a),b("Ignoring navigation",s,t);else{var i=++f.activerid,c=f.resolveUrl(s);b(e,v,document.title),e?history.replaceState(m(v),"Loading...",c):(history.replaceState(m(v),document.title,location.href),history.pushState(m(),"Loading...",c),v=void 0,window.scrollTo(0,0)),y.resetError(),d=c.match(p),f.pagesysimpl.requestPage(s,function(e){try{if(i!=f.activerid)return;var t=e.headers["x-location"]||e.headers.location;if(t){var r=_(t[0]);return h.test(r)?void f.requestPage(r.substring(f.url.length),void 0,!0):(console.warn("Requested redirect to external url:",r),void(window.location.href=r))}var o=e.headers["content-disposition"];if(o&&"attachment"==o[0].toLowerCase())throw new Error("Attachment disposition");if(!f.pagesyshandler(e))throw new Error("Could not handle response");var n=e.headers["content-type"];b("history.replaceState",document.title),history.replaceState(m(v={code:e.code,headers:e.headers,data:n&&/\/json(;.+)?$/.test(n[0])?e.contentFromJSON:e.contentAsString}),document.title,c),f.emit("page",s)}catch(e){console.warn(e),u=[s,a];try{history.go(-1)}catch(e){}}},a,i)}},this.registerComponent("a",e),window.addEventListener("popstate",function(t){g.activerid++,v=void 0;var e=location.href.match(p);if(b("popstate",e,d,t.state),e&&d&&d[1]===e[1])b("Only hash has changed...");else{d=e;var r=!!t.state;if(r&&t.state.error)w({stack:t.state.error,toString:function(){return this.stack}});else{if(u){b("forwardPopState",u);var o=u;return setTimeout(function(){f.defaultRequestPage(o[0],o[1])}),void(u=void 0)}try{if(!r)throw new Error("No state, reloading...");if(t.state.user!=f.currentUserID)throw new Error("User has changed since state was created, reloading...");var n=t.state.page;if(!n)throw new Error("Page was never loaded or page data is corrupt, reloading...");document.title=t.state.title,b(t.state.title,n),f.pagesyshandler(E(n)),t.state.body&&f.restoreComponents(document.body,t.state.body),t.state.scroll&&window.scrollTo.apply(window,t.state.scroll),y.resetError()}catch(e){console.warn(e);var s=location.href;if(h.test(s))try{if(/reloading\.\.\.$/.test(e.message))return void f.requestPage(s.substring(g.url.length),void 0,!0);console.error("Unknown error occured, actually navigating to page...")}catch(t){console.error(t)}location.reload(!0)}}}}),!0},e.prototype.defaultRequestPage=function(e,t){if(t)throw new Error("Posting is not supported without an initialized page system, yet");location.href=this.resolveUrl(e)},e.prototype.on=function(e,t){var r=this._listeners[e];r?r.push(t):this._listeners[e]=r=[t]},e.prototype.off=function(e,t){var r,o=this._listeners[e];o&&-1<(r=o.indexOf(t))&&o.splice(r,1)},e.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var o=this,n=this._listeners[e];n&&n.forEach(function(e){e.apply(o,t)})},e}();return e=window.io?function(o){function e(e){var t=o.call(this,e,window.io({path:"/:io"}))||this,r=t.io;return r.on("connect",function(){r.emit("init",y.requestedResources())}),t}return __extends(e,o),e}(t):function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(t),Object.defineProperty(window,"NexusFrameworkImpl",{value:e}),e}},NexusFrameworkClient:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkClient",{value:e})},get:function(){var e=new window.NexusFrameworkImpl;return Object.defineProperty(window,"NexusFrameworkClient",{value:e}),e}}});
//# sourceMappingURL=nexusframeworkclient.min.js.map