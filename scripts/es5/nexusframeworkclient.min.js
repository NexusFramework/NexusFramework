var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();!function(k){var g=new k.bson;Object.defineProperties(k,{NexusFrameworkTransport:{configurable:!0,set:function(e){Object.defineProperty(k,"NexusFrameworkTransport",{value:e})},get:function(){var e;if(!("XMLHttpRequest"in k))throw new Error("No transport implementations");var f=function(){function e(e,t,r,n){this._url=t,this.request=e,this.hadData=r,this.abResponse=n}return Object.defineProperty(e.prototype,"url",{get:function(){return this.request.responseURL||this._url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code",{get:function(){return this.request.status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentLength",{get:function(){return parseInt(this.request.getResponseHeader("content-length"))||this.request.responseText.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentFromJSON",{get:function(){return this.parsedJson||(this.parsedJson=JSON.parse(this.request.responseText)),this.parsedJson},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentFromBSON",{get:function(){if(!this.parsedBson){var e=this.request.response;e="string"==typeof e?Buffer.from(e,"utf8"):new Buffer(e),this.parsedBson=g.deserialize(e,{promoteValues:!0})}return this.parsedBson},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsString",{get:function(){return this.request.responseText},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsArrayBuffer",{get:function(){return this.request.response},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"headers",{get:function(){if(!this.processedHeaders){var a=this.processedHeaders={};this.request.getAllResponseHeaders().split(/\r?\n/g).forEach(function(e){var t,r,n=e.indexOf(":");0<n?(t=e.substring(0,n).trim().toLowerCase(),r=e.substring(n+1).trim()):t=e.trim().toLowerCase();var o=a[t];o||(o=a[t]=[]),r&&o.push(r)})}return this.processedHeaders},enumerable:!0,configurable:!0}),e}(),i=function(e,t,r,n,o,a,i){var s,c=new XMLHttpRequest;try{if(!i)throw!1;if((c.responseType="arraybuffer")!==c.responseType)throw console.error("Could not request arraybuffer"),!1;s=!0}catch(e){s=!1}c.open(e,t,!0),o&&Object.keys(o).forEach(function(e){c.setRequestHeader(e,o[e])}),a&&(c.onprogress=function(e){e.lengthComputable&&e.total&&a(e.loaded,e.total)}),c.onreadystatechange=function(e){c.readyState===XMLHttpRequest.DONE&&n(new f(c,t,!!r,s))};var u=r&&r.type;if(u)switch(u){case"":case"text/urlencoded":for(var l="",d=0,p=r.data;d<p.length;d++){var h=p[d];l&&(l+="&"),l+=encodeURIComponent(h[0]),l+="=",l+=encodeURIComponent(h[1])}c.setRequestHeader("Content-Type","text/urlencoded"),c.send(l);break;case"text/json":c.setRequestHeader("Content-Type","text/json"),c.send(JSON.stringify(r.data));break;case"application/bson":c.setRequestHeader("Content-Type","application/bson"),c.send(g.serialize(r.data));break;case"multipart/form-data":c.send(r.data);break;default:c.send(r)}else c.send(r)};return e={get:function(e,t,r,n,o){i("GET",e,void 0,t,r,n,o)},head:function(e,t,r,n,o){i("HEAD",e,void 0,t,r,n,o)},post:function(e,t,r,n,o,a){i("POST",e,t,r,n,o,a)},put:function(e,t,r,n,o,a){i("PUT",e,t,r,n,o,a)},execute:i,del:function(e,t,r,n,o){i("DELETE",e,void 0,t,r,n,o)}},Object.defineProperty(k,"NexusFrameworkTransport",{value:e}),e}},NexusFrameworkImpl:{configurable:!0,set:function(e){Object.defineProperty(k,"NexusFrameworkImpl",{value:e})},get:function(){var e,x=k.NexusFrameworkLoader,p=x.showError,A=console.log.bind(console),r={reportError:function(e,t){if(k.ga)try{k.ga("send","exception",{exDescription:(e.stack||""+e).replace(/\n/g,"\n\t"),exFatal:t})}catch(e){console.warn(e)}},reportEvent:function(e,t,r,n){if(k.ga)try{k.ga("send","event",e,t,r,n)}catch(e){console.warn(e)}},reportPage:function(e){if(k.ga)try{e||(e=location.pathname),k.ga("set","page",e),k.ga("send","pageview")}catch(e){console.warn(e)}}},n=document.createElement("a"),o=location.href.match(/^\w+:/)[0],O=function(e){n.setAttribute("href",e);var t=n.href;return/^\/\//.test(t)&&(t=o+t),t},g=/(^|\s)loader\-(progress|error)\-container(\s|$)/,t=function(){function e(e,t){void 0===e&&(e="/"),this.activerid=0,this.components={},this.currentUserID=void 0,this.progressVisible=!1,this.animationTiming=500,this.requestPage=this.defaultRequestPage,this._listeners={},e=O(e),/\/$/.test(e)||(e+="/"),Object.defineProperties(this,{io:{value:t},url:{value:e}}),this._analytics=r}return e.prototype.resolveUrl=function(e){return/^\w+\:/.test(e)?e:O(this.url+e)},e.prototype.disableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("a, input, select, textarea, iframe, button, *[focusable], *[tabindex]"),r=0;r<t.length;r++){var n=t[r],o=n.getAttribute("tabindex");if("-1"==o)return;n.setAttribute("data-tabindex",o||""),n.setAttribute("data-tabindex","-1")}},e.prototype.enableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("*[data-tabindex]"),r=0;r<t.length;r++){var n=t[r];n.setAttribute("tabindex",n.getAttribute("data-tabindex")),n.removeAttribute("data-tabindex")}},Object.defineProperty(e.prototype,"analytics",{get:function(){return this._analytics},set:function(e){this._analytics=e||r},enumerable:!0,configurable:!0}),e.prototype.reportError=function(e,t){console[t?"error":"warn"](e.stack),this.errorreporter&&this.errorreporter(e,t)},e.prototype.installErrorReporter=function(e){this.errorreporter=e},e.prototype.registerComponent=function(i,e){var s=this;if(e)this.components[i]=e,this.createComponents(document.head),this.createComponents(document.body);else{delete this.components[i];var t=function(e){var t=e.querySelectorAll(i);if(t.length)for(var r=0;r<t.length;r++){var n=t[r],o=n.__nf_cmapping__;o||(o=n.__nf_cmapping__={});var a=o[i];if(a)try{a.destroy()}catch(e){s.reportError(e)}}};t(document.head),t(document.body)}},e.prototype.unregisterComponent=function(e,t){},e.prototype.createComponents=function(i){var s=this;Object.keys(this.components).forEach(function(e){var t=i.querySelectorAll(e);if(t.length)for(var r=0;r<t.length;r++){var n=t[r],o=n.__nf_cmapping__;if(o||(o=n.__nf_cmapping__={}),!o[e]){var a=s.components[e];try{(o[e]=new a).create(n)}catch(e){s.reportError(e)}}}})},e.prototype.destroyComponents=function(i){var s=this;Object.keys(this.components).forEach(function(e){var t=i.querySelectorAll(e);if(t.length)for(var r=0;r<t.length;r++){var n=t[r],o=n.__nf_cmapping__;o||(o=n.__nf_cmapping__={});var a=o[e];if(a)try{a.destroy()}catch(e){s.reportError(e)}}})},e.prototype.restoreComponents=function(u,l){var d=this;Object.keys(this.components).forEach(function(e){var t=l[e];if(t){var r=u.querySelectorAll(e);if(r.length)for(var n=0;n<r.length;n++){var o=r[n];if(!t.length)break;var a=t.shift();if(a){var i=o.__nf_cmapping__;i||(i=o.__nf_cmapping__={});var s=i[e];if(!s){var c=d.components[e];try{(s=i[e]=new c).create(o)}catch(e){d.reportError(e),console.warn(e);continue}}try{s.restore(a)}catch(e){d.reportError(e),console.warn(e)}}}}})},e.prototype.saveComponents=function(c){var u=this,l={};return Object.keys(this.components).forEach(function(e){var t=l[e]=[],r=c.querySelectorAll(e);if(r.length)for(var n=0;n<r.length;n++){var o=r[n],a=o.__nf_cmapping__;a||(a=o.__nf_cmapping__={});var i=a[e];if(!i){var s=u.components[e];try{(i=a[e]=new s).create(o)}catch(e){t.push(void 0),u.reportError(e),console.warn(e);continue}}try{t.push(i.save())}catch(e){t.push(void 0),u.reportError(e),console.warn(e)}}}),l},e.prototype.initPageSystem=function(u){var m=this;if(!x)return console.error("The NexusFramework Loader is required for the dynamic Page System to work correctly.");if(!history.pushState||!history.replaceState)return console.warn("This browser is missing an essential feature required for the dynamic Page System.");if(this.pagesyshandler)return console.warn("Page System already initialized, ignoring additional requests to initialize.");u=u||{};var y=this,v=0,b=[];this.animationTiming=u.animationTiming||500;var w=u.pageHistoryCacheSize||25e6,l=function(r){return function(e){var t=e.headers["x-logged-user"];y.currentUserID=t?t[0]:void 0,A("Current UID",y.currentUserID),r(e),200===e.code&&setTimeout(function(){y._analytics.reportPage()})}};x.showError=function(e){var t=location.href.match(q),r=t&&t[1]||location.href,n=e.stack.length,o=w<=n;try{for(var a=b.length,i=0;i<a;i++){var s=b[i];if(s.url===r)throw o?(b.splice(i,1),v-=s.size):(s.data={error:e},s.updated=+new Date,v+=n-s.size),!0}if(o)throw!0;b.push({url:r,data:{error:e},updated:+new Date,size:n}),v+=n}catch(e){if(!0!==e)throw e}return p(e)};var n={requestPage:function(e,t,r,n){if(!y.pagesysprerequest||y.pagesysprerequest(e)){u.noprogress||(y.disableAll(),x.showProgress());var o=y.resolveUrl(":pagesys/"+e),a=u.noprogress?t:function(e){u.noprogress?t(e):x.showProgress(function(){t(e),y.enableAll()})};r?k.NexusFrameworkTransport.post(o,r,l(a),void 0,void 0,!0):k.NexusFrameworkTransport.get(o,l(a),void 0,void 0,!0)}else y.defaultRequestPage(e,r)}};if(!u.noio&&this.io){var o=this.io;this.pagesysimpl={requestPage:function(i,s,e,c){if(o.connected){if(y.pagesysprerequest&&!y.pagesysprerequest(i))return void y.defaultRequestPage(i,e);u.noprogress||(y.disableAll(),x.showProgress());var t={referrer:location.href},r=document.cookie;r&&(t.cookie=r),o.emit("page",e?"POST":"GET",i,e,t,function(e){if(c==y.activerid){var t=e.headers["set-cookie"];t&&t.forEach(function(e){document.cookie=e});var r,n,o,a=u.noprogress?s:function(e){u.noprogress?x.showProgress(function(){s(e),y.enableAll()}):s(e)};l(a)((r=e,void 0===(n=y.resolveUrl(i))&&(n=location.href),"string"==typeof r.data?{url:n,code:r.code,contentAsString:r.data,get contentLength(){return parseInt(r.headers["content-length"]&&r.headers["content-length"][0])||r.data.length},get contentAsArrayBuffer(){throw new Error("Not implemented")},get contentFromBSON(){return o||(o=JSON.parse(r.data)),o},get contentFromJSON(){return o||(o=JSON.parse(r.data)),o},headers:r.headers}:{url:n,code:r.code,get contentAsString(){return o||(o=JSON.stringify(r.data)),o},get contentAsArrayBuffer(){throw new Error("Not implemented")},contentFromJSON:r.data,contentFromBSON:r.data,headers:r.headers,get contentLength(){var e=parseInt(r.headers["content-length"]&&r.headers["content-length"][0]);return e||(o||(o=JSON.stringify(r.data)),o.length)}}))}})}else n.requestPage(i,s,e,c)}}}else this.pagesysimpl=n;var _,P=document.getElementsByTagName("base");P=P&&P[0],this.pagesysprerequest=u.prerequest,this.pagesyshandler=u.handler||function(e,t){try{var r=e.headers["content-type"][0];if(!/\/html(;.+)?$/.test(r.toLowerCase()))throw new Error("Content type is not html")}catch(e){}var n=e.contentAsString,o=n.indexOf("<body");if(-1==o)throw new Error("Could not find start of body tag");var a=n.indexOf("</body>")||n.indexOf("</ body>");if(-1==a)throw new Error("Could not find end of body tag");var i=n.match(/<title>([^<]+)<\/\s*title>/);document.title=i&&i[1]||"Title Not Set";var s,c=document.createElement("html");c.innerHTML=n.substring(o,a)+"</body>";for(var u=c.children,l=[],d=0;d<u.length;d++){switch((h=u[d]).nodeName.toUpperCase()){case"HEAD":break;case"BODY":d=-1,u=h.children;break;case"SCRIPT":var p=h.innerHTML.match(/^NexusFrameworkLoader\.load\((.+)\);?$/);p&&(s=JSON.parse(p[1]));break;default:if(g.test(h.className))break;l.push(h)}}if(!l.length)throw new Error("Nothing found in response to add to page");if(!s)throw new Error("NexusFrameworkLoader script not found...");for(d=(u=document.body.children).length-1;0<=d;d--){var h;switch((h=u[d]).nodeName.toUpperCase()){case"LINK":case"SCRIPT":break;default:if(g.test(h.className))break;document.body.removeChild(h)}}var f=document.createDocumentFragment();return l.forEach(function(e){f.appendChild(e),m.createComponents(e)}),document.body.appendChild(f),x.load(s,function(){y.progressVisible=!0,x.resetProgress(),t()}),!0};var q=/^([^#]+)(#.*)?$/,E=location.href.match(q)[1],S=new RegExp("^"+this.url.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"(.*)$","i"),e=function(){function e(){var a=this;this.handler=function(e){if(!a.element.hasAttribute("data-nopagesys")&&!a.element.hasAttribute("data-nodynamic")){var t=a.element.getAttribute("href");if(t&&t.length){var r=a.element.href,n=r.match(q);if(!n[2]||E!==n[1])if(S.test(r))try{var o=r.match(/^(.+)#.*$/);o&&(r=o[1]),y.requestPage(r.substring(y.url.length));try{e.stopPropagation()}catch(e){}try{e.preventDefault()}catch(e){}}catch(e){console.warn(e)}else A("Navigating",r)}}}}return e.prototype.create=function(e){e.addEventListener("click",this.handler),this.element=e},e.prototype.destroy=function(){this.element.removeEventListener("click",this.handler)},e.prototype.restore=function(e){},e.prototype.save=function(){},e}(),t=function(){function e(){var p=this;this.handler=function(e){if(!p.element.hasAttribute("data-nopagesys")&&!p.element.hasAttribute("data-nodynamic")){var t=p.element.getAttribute("method")||"get",r=p.element.getAttribute("enctype")||"text/urlencoded",n=p.element.getAttribute("action")||"",o=O(n);if(S.test(o))try{var a=o.match(/^(.+)#.*$/);a&&(o=a[1]);var i=new FormData(p.element);if(x.showProgress(void 0,"Submitting Form","Your form data is being processed"),"post"===t.trim().toLowerCase())y.requestPage(o.substring(y.url.length),{type:r,data:i});else{for(var s=!0,c=o.substring(y.url.length)+"?",u=0,l=i;u<l.length;u++){var d=l[u];s?s=!1:c+="&",c+=encodeURIComponent(d[0]),c+="=",c+=encodeURIComponent(d[1])}y.requestPage(c)}try{e.stopPropagation()}catch(e){}try{e.preventDefault()}catch(e){}return Array.prototype.forEach.call(p.element.querySelectorAll("a, input, select, textarea, iframe, button, *[name]"),function(e){e.setAttribute("disabled","disabled"),e.className+=" disabled"}),Array.prototype.forEach.call(p.element.querySelectorAll("button:not([type]), button[type=submit]"),function(e){e.innerHTML="Processing Request"}),void Array.prototype.forEach.call(p.element.querySelectorAll("input[type=submit]"),function(e){e.value="Processing Request"})}catch(e){A(e)}A("Submitting",o)}}}return e.prototype.create=function(e){e.addEventListener("submit",this.handler),this.element=e},e.prototype.destroy=function(){this.element.removeEventListener("submit",this.handler)},e.prototype.restore=function(e){},e.prototype.save=function(){},e}(),a=this.requestPage=function(l,d,p){void 0===p&&(p=!1);var e=l.match(/\.([^\/]+)([\?#].*)?$/);if(e&&"htm"!==e[0]&&"html"!==e[0])m.defaultRequestPage(l,d),A("Ignoring navigation",l,e);else{A("requestPage",l);var h=++y.activerid,f=m.resolveUrl(l),g=f+(e&&e[2]||"");p?history.replaceState(!!d,"Loading...",g):(history.pushState(!!d,"Loading...",g),E=g.match(q)[1],k.scrollTo(0,0)),x.resetError(),x.resetProgress(),m.pagesysimpl.requestPage(l,function(u){try{if(h!==y.activerid)return;if(!u.code)return x.showProgress(void 0,"Connection Issue","Check your network and try again"),document.title="Connection Issue",history.replaceState(u.hadData,"Connection Issue",g),void setTimeout(function(){h===y.activerid&&a(l,d,!0)},9e5);if(502===u.code||503===u.code)return x.showProgress(void 0,"Scheduled Maintenance","Sorry but this website is undergoing scheduled maintenance"),document.title="Scheduled Maintenance",history.replaceState(u.hadData,"Scheduled Maintenance",g),void setTimeout(function(){h===y.activerid&&a(l,d,!0)},9e5);var e=u.headers["x-location"]||u.headers.location;if(e){var t=O(e[0]);return S.test(t)?void m.requestPage(t.substring(m.url.length),void 0,!0):(console.warn("Requested redirect to external url:",t),void(k.location.href=t))}var r=u.headers["content-disposition"];if(r&&"attachment"==r[0].toLowerCase())throw new Error("Attachment disposition");m.pagesyshandler(u,function(){if(h===y.activerid)try{var t,e=document.title,r=u.contentLength,n=w<=r,o=n?void 0:{title:e,user:y.currentUserID,scroll:[k.scrollX,k.scrollY],body:y.saveComponents(document.body),basehref:P?P.href:void 0,response:u},a=b.length;try{for(t=0;t<a;t++){var i=b[t];if(i.url===f)throw n?(b.splice(t,1),v-=i.size):(i.data=o,i.updated=+new Date,v+=r-i.size),!0}if(!n)throw b.push({url:f,data:o,updated:+new Date,size:r}),v+=r,!0;A("Response too big to store",f,r)}catch(e){if(!0!==e)throw e;var s=v-w;if(0<s){b.sort(function(e,t){return e.updated-t.updated});var c=0;for(t=0;t<a&&!(s<=(c+=b[t].size));t++);t++,b.splice(0,t),A("Trimmed",t,"items...")}}history.replaceState(u.hadData,document.title,g),y.emit("page",f,l)}catch(e){if(A(e),p)k.location.reload(!0);else try{E=void 0,_=[l,d],A("Going backwards"),history.go(-1)}catch(e){}}})}catch(e){if(A(e),p)k.location.reload(!0);else try{E=void 0,_=[l,d],A("Going backwards"),history.go(-1)}catch(e){}}},d,h)}};return this.registerComponent("a",e),this.registerComponent("form",t),k.addEventListener("popstate",function(t){try{for(var r,e=location.href.match(q),n=b.length,o=e[1],a=0;a<n;a++){var i=b[a];if(i.url===o){r=i;break}}var s=!!r,c=++y.activerid,u=s&&r.data.error;if(u)return void p(u);if(_){A("forwardPopState",_);var l=_;return setTimeout(function(){c===y.activerid&&y.defaultRequestPage(l[0],l[1])}),void(_=void 0)}if(E===o)return void A("Only hash has changed...",o);if(E=e[1],t.state&&alert("You submitted data to this page, which cannot be re-sent. Because of this, what you're viewing may not be the same now."),!s)throw new Error("No state for: "+o+", reloading...");if(r.data.user!=y.currentUserID)throw new Error("User has changed since state was created, reloading...");document.title=r.data.title,x.resetProgress(),x.resetError(),y.pagesyshandler(r.data.response,function(e){if(c===y.activerid)try{if(e)throw e;r.data.body&&y.restoreComponents(document.body,r.data.body),r.data.scroll&&k.scrollTo.apply(k,r.data.scroll),A("Used stored page state!",r)}catch(e){A(e);var t=location.href;if(S.test(t))try{if(/reloading\.\.\.$/.test(e.message))return void y.requestPage(t.substring(y.url.length),void 0,!0);console.error("Unknown error occured, actually navigating to page...")}catch(e){console.error(e)}location.reload(!0)}})}catch(e){A(e);var d=location.href;if(S.test(d))try{if(/reloading\.\.\.$/.test(e.message))return void y.requestPage(d.substring(y.url.length),void 0,!0);console.error("Unknown error occured, actually navigating to page...")}catch(t){console.error(t)}location.reload(!0)}}),!0},Object.defineProperty(e.prototype,"currentUser",{get:function(){return this.currentUserID},enumerable:!0,configurable:!0}),e.prototype.defaultRequestPage=function(e,t){if(t)throw new Error("Posting is not supported without an initialized page system, yet");location.href=this.resolveUrl(e)},e.prototype.on=function(e,t){var r=this._listeners[e];r?r.push(t):this._listeners[e]=r=[t]},e.prototype.off=function(e,t){var r,n=this._listeners[e];n&&-1<(r=n.indexOf(t))&&n.splice(r,1)},e.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var n=this,o=this._listeners[e];o&&o.forEach(function(e){e.apply(n,t)})},e}();return e=k.io?function(n){function e(e){var t=n.call(this,e,k.io({path:"/:io"}))||this,r=t.io;return r.on("connect",function(){r.emit("init",x.requestedResources())}),t}return __extends(e,n),e}(t):function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(t),Object.defineProperty(k,"NexusFrameworkImpl",{value:e}),e}},NexusFrameworkClient:{configurable:!0,set:function(e){Object.defineProperty(k,"NexusFrameworkClient",{value:e})},get:function(){var e=new k.NexusFrameworkImpl;return Object.defineProperty(k,"NexusFrameworkClient",{value:e}),e}}})}(window);
//# sourceMappingURL=nexusframeworkclient.min.js.map