var __extends=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperties(window,{NexusFrameworkTransport:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkTransport",{value:e})},get:function(){var e;if("XMLHttpRequest"in window){var s=function(){function e(e,t){this._url=t,this.request=e}return Object.defineProperty(e.prototype,"url",{get:function(){return this.request.responseURL||this._url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code",{get:function(){return this.request.status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentLength",{get:function(){return parseInt(this.request.getResponseHeader("content-length"))||this.request.responseText.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentFromJSON",{get:function(){return this.parsedJson||(this.parsedJson=JSON.parse(this.request.responseText)),this.parsedJson},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentAsString",{get:function(){return this.request.responseText},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"headers",{get:function(){if(!this.processedHeaders){var a=this.processedHeaders={};this.request.getAllResponseHeaders().split(/\r?\n/g).forEach(function(e){var t,r,o=e.indexOf(":");0<o?(t=e.substring(0,o).trim().toLowerCase(),r=e.substring(o+1).trim()):t=e.trim().toLowerCase();var n=a[t];n||(n=a[t]=[]),r&&n.push(r)})}return this.processedHeaders},enumerable:!0,configurable:!0}),e}(),a=function(e,t,r,o,n,a){var i=new XMLHttpRequest;i.open(e,t,!0),n&&Object.keys(n).forEach(function(e){i.setRequestHeader(e,n[e])}),a&&(i.onprogress=function(e){e.lengthComputable&&e.total&&a(e.loaded,e.total)}),i.onreadystatechange=function(e){i.readyState===XMLHttpRequest.DONE&&o(new s(i,t))},i.send(r)};e={get:function(e,t,r,o){a("GET",e,void 0,t,r,o)},head:function(e,t,r,o){a("HEAD",e,void 0,t,r,o)},post:function(e,t,r,o,n){a("POST",e,t,r,o,n)},put:function(e,t,r,o,n){a("PUT",e,t,r,o,n)},execute:a,del:function(e,t,r,o){a("DELETE",e,void 0,t,r,o)}}}else e={get:function(e,t,r){t({url:e,code:0,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",contentLength:0,headers:{}})},head:function(e,t,r){t({url:e,code:0,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",contentLength:0,headers:{}})},put:function(e,t,r,o){r({url:e,code:0,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",contentLength:0,headers:{}})},post:function(e,t,r,o){r({url:e,code:0,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",contentLength:0,headers:{}})},execute:function(e,t,r,o,n){o({url:t,code:0,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",contentLength:0,headers:{}})},del:function(e,t,r){t({url:e,code:0,get contentFromJSON(){throw new Error("No response to parse.")},contentAsString:"",contentLength:0,headers:{}})}};return Object.defineProperty(window,"NexusFrameworkTransport",{value:e}),e}},NexusFrameworkImpl:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkImpl",{value:e})},get:function(){var e,N=window.NexusFrameworkLoader,h=N.showError,x=console.log.bind(console),r={reportError:function(e,t){if(window.ga)try{window.ga("send","exception",{exDescription:(e.stack||""+e).replace(/\n/g,"\n\t"),exFatal:t})}catch(e){console.warn(e)}},reportEvent:function(e,t,r,o){if(window.ga)try{window.ga("send","event",e,t,r,o)}catch(e){console.warn(e)}},reportPage:function(e){if(window.ga)try{e||(e=location.pathname),window.ga("set","page",e),window.ga("send","pageview")}catch(e){console.warn(e)}}},o=document.createElement("a"),n=location.href.match(/^\w+:/)[0],i=function(e){o.setAttribute("href",e);var t=o.href;return/^\/\//.test(t)&&(t=n+t),t},g=/(^|\s)loader\-(progress|error)\-container(\s|$)/,t=function(){function e(e,t){void 0===e&&(e="/"),this.activerid=0,this.components={},this.currentUserID=void 0,this.progressVisible=!1,this.animationTiming=500,this.requestPage=this.defaultRequestPage,this._listeners={},e=i(e),/\/$/.test(e)||(e+="/"),Object.defineProperties(this,{io:{value:t},url:{value:e}}),this._analytics=r}return e.prototype.resolveUrl=function(e){return/^\w+\:/.test(e)?e:i(this.url+e)},e.prototype.disableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("a, input, select, textarea, iframe, button, *[focusable], *[tabindex]"),r=0;r<t.length;r++){var o=t[r],n=o.getAttribute("tabindex");if("-1"==n)return;o.setAttribute("data-tabindex",n||""),o.setAttribute("data-tabindex","-1")}},e.prototype.enableAll=function(e){void 0===e&&(e=document.body);for(var t=e.querySelectorAll("*[data-tabindex]"),r=0;r<t.length;r++){var o=t[r];o.setAttribute("tabindex",o.getAttribute("data-tabindex")),o.removeAttribute("data-tabindex")}},Object.defineProperty(e.prototype,"analytics",{get:function(){return this._analytics},set:function(e){this._analytics=e||r},enumerable:!0,configurable:!0}),e.prototype.reportError=function(e,t){console[t?"error":"warn"](e.stack),this.errorreporter&&this.errorreporter(e,t)},e.prototype.installErrorReporter=function(e){this.errorreporter=e},e.prototype.registerComponent=function(i,e){var s=this;if(e)this.components[i]=e,this.createComponents(document.head),this.createComponents(document.body);else{delete this.components[i];var t=function(e){var t=e.querySelectorAll(i);if(t.length)for(var r=0;r<t.length;r++){var o=t[r],n=o.__nf_cmapping__;n||(n=o.__nf_cmapping__={});var a=n[i];if(a)try{a.destroy()}catch(e){s.reportError(e)}}};t(document.head),t(document.body)}},e.prototype.unregisterComponent=function(e,t){},e.prototype.createComponents=function(i){var s=this;Object.keys(this.components).forEach(function(e){var t=i.querySelectorAll(e);if(t.length)for(var r=0;r<t.length;r++){var o=t[r],n=o.__nf_cmapping__;if(n||(n=o.__nf_cmapping__={}),!n[e]){var a=s.components[e];try{(n[e]=new a).create(o)}catch(e){s.reportError(e)}}}})},e.prototype.destroyComponents=function(i){var s=this;Object.keys(this.components).forEach(function(e){var t=i.querySelectorAll(e);if(t.length)for(var r=0;r<t.length;r++){var o=t[r],n=o.__nf_cmapping__;n||(n=o.__nf_cmapping__={});var a=n[e];if(a)try{a.destroy()}catch(e){s.reportError(e)}}})},e.prototype.restoreComponents=function(u,d){var l=this;Object.keys(this.components).forEach(function(e){var t=d[e];if(t){var r=u.querySelectorAll(e);if(r.length)for(var o=0;o<r.length;o++){var n=r[o];if(!t.length)break;var a=t.shift();if(a){var i=n.__nf_cmapping__;i||(i=n.__nf_cmapping__={});var s=i[e];if(!s){var c=l.components[e];try{(s=i[e]=new c).create(n)}catch(e){l.reportError(e),console.warn(e);continue}}try{s.restore(a)}catch(e){l.reportError(e),console.warn(e)}}}}})},e.prototype.saveComponents=function(c){var u=this,d={};return Object.keys(this.components).forEach(function(e){var t=d[e]=[],r=c.querySelectorAll(e);if(r.length)for(var o=0;o<r.length;o++){var n=r[o],a=n.__nf_cmapping__;a||(a=n.__nf_cmapping__={});var i=a[e];if(!i){var s=u.components[e];try{(i=a[e]=new s).create(n)}catch(e){t.push(void 0),u.reportError(e),console.warn(e);continue}}try{t.push(i.save())}catch(e){t.push(void 0),u.reportError(e),console.warn(e)}}}),d},e.prototype.initPageSystem=function(u){var v=this;if(!N)return console.error("The NexusFramework Loader is required for the dynamic Page System to work correctly.");if(!history.pushState||!history.replaceState)return console.warn("This browser is missing an essential feature required for the dynamic Page System.");u=u||{};var m=this,w=0,y=[];this.animationTiming=u.animationTiming||500;var b=u.pageHistoryCacheSize||25e6,d=function(r){return function(e){var t=e.headers["x-logged-user"];m.currentUserID=t?t[0]:void 0,x("Current UID",m.currentUserID),r(e),200===e.code&&setTimeout(function(){m._analytics.reportPage()})}};N.showError=function(e){var t=location.href.match(E),r=t&&t[1]||location.href,o=e.stack.length,n=b<=o;try{for(var a=y.length,i=0;i<a;i++){var s=y[i];if(s.url===r)throw n?(y.splice(i,1),w-=s.size):(s.data={error:e},s.updated=+new Date,w+=o-s.size),!0}if(n)throw!0;y.push({url:r,data:{error:e},updated:+new Date,size:o}),w+=o}catch(e){if(!0!==e)throw e}return h(e)};var o={requestPage:function(e,t,r,o){if(!m.pagesysprerequest||m.pagesysprerequest(e)){u.noprogress||(m.disableAll(),N.showProgress());var n=m.resolveUrl(":pagesys/"+e),a=u.noprogress?t:function(e){u.noprogress?t(e):N.showProgress(!1,function(){t(e),m.enableAll()})};r?window.NexusFrameworkTransport.post(n,r,d(a)):window.NexusFrameworkTransport.get(n,d(a))}else m.defaultRequestPage(e,r)}};if(u.noio||u.nopagesysio||!this.io)this.pagesysimpl=o;else{var n=this.io;this.pagesysimpl={requestPage:function(i,s,e,c){if(n.connected){if(m.pagesysprerequest&&!m.pagesysprerequest(i))return void m.defaultRequestPage(i,e);u.noprogress||(m.disableAll(),N.showProgress());var t={referrer:location.href},r=document.cookie;r&&(t.cookie=r),n.emit("page",e?"POST":"GET",i,e,t,function(e){if(c==m.activerid){var t=e.headers["set-cookie"];t&&t.forEach(function(e){document.cookie=e});var r,o,n,a=u.noprogress?s:function(e){u.noprogress?N.showProgress(!1,function(){s(e),m.enableAll()}):s(e)};d(a)((r=e,void 0===(o=m.resolveUrl(i))&&(o=location.href),"string"==typeof r.data||r.data instanceof String?{url:o,code:r.code,contentAsString:r.data,get contentLength(){return parseInt(r.headers["content-length"]&&r.headers["content-length"][0])||r.data.length},get contentFromJSON(){return n||(n=JSON.parse(r.data)),n},headers:r.headers}:{url:o,code:r.code,get contentAsString(){return n||(n=JSON.stringify(r.data)),n},contentFromJSON:r.data,headers:r.headers,get contentLength(){var e=parseInt(r.headers["content-length"]&&r.headers["content-length"][0]);return e||(n||(n=JSON.stringify(r.data)),n.length)}}))}})}else o.requestPage(i,s,e,c)}}}var _,P=document.getElementsByTagName("base");P=P&&P[0],this.pagesysprerequest=u.prerequest,this.pagesyshandler=u.handler||function(e,t){try{var r=e.headers["content-type"][0];if(!/\/html(;.+)?$/.test(r.toLowerCase()))throw new Error("Content type is not html")}catch(e){}var o=e.contentAsString,n=o.indexOf("<body");if(-1==n)throw new Error("Could not find start of body tag");var a=o.indexOf("</body>")||o.indexOf("</ body>");if(-1==a)throw new Error("Could not find end of body tag");var i=o.match(/<title>([^<]+)<\/\s*title>/);document.title=i&&i[1]||"Title Not Set";var s,c=document.createElement("html");c.innerHTML=o.substring(n,a)+"</body>";for(var u=c.children,d=[],l=0;l<u.length;l++){switch((p=u[l]).nodeName.toUpperCase()){case"HEAD":break;case"BODY":l=-1,u=p.children;break;case"SCRIPT":var h=p.innerHTML.match(/^NexusFrameworkLoader\.load\((.+)\);?$/);h&&(s=JSON.parse(h[1]));break;default:if(g.test(p.className))break;d.push(p)}}if(!d.length)throw new Error("Nothing found in response to add to page");if(!s)throw new Error("NexusFrameworkLoader script not found...");for(l=(u=document.body.children).length-1;0<=l;l--){var p;switch((p=u[l]).nodeName.toUpperCase()){case"LINK":case"SCRIPT":break;default:if(g.test(p.className))break;document.body.removeChild(p)}}var f=document.createDocumentFragment();return d.forEach(function(e){f.appendChild(e),v.createComponents(e)}),document.body.appendChild(f),N.load(s,function(){m.progressVisible=!0,N.resetProgress(),t()}),!0};var E=/^([^#]+)(#.*)?$/,S=location.href.match(E),O=new RegExp("^"+this.url.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"(.*)$","i"),e=function(){function e(){var a=this;this.handler=function(e){if(!a.element.hasAttribute("data-nopagesys")&&!a.element.hasAttribute("data-nodynamic")){var t=a.element.getAttribute("href");if(t&&t.length){var r=a.element.href,o=r.match(E);if(!(o&&S&&o[2]&&S[1]===o[1]))if(S=o,O.test(r))try{var n=r.match(/^(.+)#.*$/);n&&(r=n[1]),m.requestPage(r.substring(m.url.length));try{e.stopPropagation()}catch(e){}try{e.preventDefault()}catch(e){}}catch(e){console.warn(e)}else x("Navigating",r)}}}}return e.prototype.create=function(e){e.addEventListener("click",this.handler),this.element=e},e.prototype.destroy=function(){this.element.removeEventListener("click",this.handler)},e.prototype.restore=function(e){},e.prototype.save=function(){},e}(),a=this.requestPage=function(d,l,h){void 0===h&&(h=!1);var e=d.match(/\.([^\/]+)([\?#].*)?$/);if(e&&"htm"!==e[0]&&"html"!==e[0])v.defaultRequestPage(d,l),x("Ignoring navigation",d,e);else{var p=++m.activerid,f=v.resolveUrl(d),g=f+(e&&e[2]||"");h?history.replaceState(void 0,"Loading...",g):(history.replaceState(void 0,document.title,location.href),history.pushState(void 0,"Loading...",g),window.scrollTo(0,0)),N.resetError(),N.resetProgress(),S=g.match(E),v.pagesysimpl.requestPage(d,function(u){try{if(p!==m.activerid)return;if(!u.code||502===u.code||503===u.code)return N.showProgress(!0),document.title="Maintenance",history.replaceState(void 0,"Maintenance",g),void setTimeout(function(){p===m.activerid&&a(d,l,!0)},15e3);var e=u.headers["x-location"]||u.headers.location;if(e){var t=i(e[0]);return O.test(t)?void v.requestPage(t.substring(v.url.length),void 0,!0):(console.warn("Requested redirect to external url:",t),void(window.location.href=t))}var r=u.headers["content-disposition"];if(r&&"attachment"==r[0].toLowerCase())throw new Error("Attachment disposition");v.pagesyshandler(u,function(){if(p===m.activerid)try{var e=document.title;u.headers["content-type"];x("history.replaceState",e);var t,r=u.contentLength,o=b<=r,n=o?void 0:{title:e,user:m.currentUserID,scroll:[window.scrollX,window.scrollY],body:m.saveComponents(document.body),basehref:P?P.href:void 0,response:u},a=y.length;try{for(t=0;t<a;t++){var i=y[t];if(i.url===f)throw o?(y.splice(t,1),w-=i.size):(i.data=n,i.updated=+new Date,w+=r-i.size),!0}if(!o)throw y.push({url:f,data:n,updated:+new Date,size:r}),w+=r,!0;x("Response too big to store",f,r)}catch(e){if(!0!==e)throw e;var s=w-b;if(0<s){y.sort(function(e,t){return e.updated-t.updated});var c=0;for(t=0;t<a&&!(s<=(c+=y[t].size));t++);t++,y.splice(0,t),x("Trimmed",t,"items...")}}history.replaceState(void 0,document.title,g),m.emit("page",f,d)}catch(e){if(x(e),x("forwardPopState",_=[d,l]),!h)try{x("Going backwards"),history.go(-1)}catch(e){}}})}catch(e){if(x(e),x("forwardPopState",_=[d,l]),!h)try{x("Going backwards"),history.go(-1)}catch(e){}}},l,p)}};return this.registerComponent("a",e),window.addEventListener("popstate",function(e){for(var t,r=location.href.match(E),o=r[1]||location.href,n=y.length,a=0;a<n;a++){var i=y[a];if(i.url===o){t=i;break}}var s=!!t;if(S&&S[1]===r[1])x("Only hash has changed...");else{S=r;var c=++m.activerid,u=s&&t.data.error;if(u)h(u);else{if(_){x("forwardPopState",_);var d=_;return setTimeout(function(){c===m.activerid&&m.defaultRequestPage(d[0],d[1])}),void(_=void 0)}var l=function(e){x(e);var t=location.href;if(O.test(t))try{if(/reloading\.\.\.$/.test(e.message))return void m.requestPage(t.substring(m.url.length),void 0,!0);console.error("Unknown error occured, actually navigating to page...")}catch(e){console.error(e)}location.reload(!0)};try{if(!s)throw new Error("No state for: "+o+", reloading...");if(t.data.user!=m.currentUserID)throw new Error("User has changed since state was created, reloading...");document.title=t.data.title,N.resetProgress(),N.resetError(),m.pagesyshandler(t.data.response,function(e){if(c===m.activerid)try{if(e)throw e;t.data.body&&m.restoreComponents(document.body,t.data.body),t.data.scroll&&window.scrollTo.apply(window,t.data.scroll),x("Used stored page state!",t)}catch(e){l(e)}})}catch(e){l(e)}}}}),!0},e.prototype.defaultRequestPage=function(e,t){if(t)throw new Error("Posting is not supported without an initialized page system, yet");location.href=this.resolveUrl(e)},e.prototype.on=function(e,t){var r=this._listeners[e];r?r.push(t):this._listeners[e]=r=[t]},e.prototype.off=function(e,t){var r,o=this._listeners[e];o&&-1<(r=o.indexOf(t))&&o.splice(r,1)},e.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var o=this,n=this._listeners[e];n&&n.forEach(function(e){e.apply(o,t)})},e}();return e=window.io?function(o){function e(e){var t=o.call(this,e,window.io({path:"/:io"}))||this,r=t.io;return r.on("connect",function(){r.emit("init",N.requestedResources())}),t}return __extends(e,o),e}(t):function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(t),Object.defineProperty(window,"NexusFrameworkImpl",{value:e}),e}},NexusFrameworkClient:{configurable:!0,set:function(e){Object.defineProperty(window,"NexusFrameworkClient",{value:e})},get:function(){var e=new window.NexusFrameworkImpl;return Object.defineProperty(window,"NexusFrameworkClient",{value:e}),e}}});
//# sourceMappingURL=nexusframeworkclient.min.js.map